<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parrish Health Systems | Care Dashboard</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    :root {
      /* BRANDING UPDATE: Green Theme */
      --primary: #16a34a; /* Modern Medical Green */
      --primary-hover: #15803d;
      --primary-light: #dcfce7;
      
      --sidebar-width: 280px; /* Widened slightly for full title */
      --text-dark: #111827;
      --text-muted: #6b7280;
      --bg-surface: #f9fafb;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-surface);
      color: var(--text-dark);
      overflow-x: hidden;
    }

    /* --- Secure Entry --- */
    #authOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex; align-items: center; justify-content: center;
    }
    .pin-box { width: 340px; text-align: center; }
    .pin-dots { font-size: 2rem; letter-spacing: 1rem; border: none; background: transparent; text-align: center; width: 100%; outline: none; }
    
    /* --- Layout --- */
    .app-container { display: flex; min-height: 100vh; display: none; /* Hidden until PIN */ }
    
    .sidebar {
      width: var(--sidebar-width);
      background: white;
      border-right: 1px solid #e5e7eb;
      position: fixed; height: 100vh;
      padding: 1.5rem;
      display: flex; flex-direction: column;
    }

    .main-content {
      margin-left: var(--sidebar-width);
      flex: 1;
      padding: 2rem;
    }

    /* --- Navigation --- */
    .nav-item {
      display: flex; align-items: center;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }
    .nav-item:hover { background: var(--bg-surface); color: var(--primary); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); }
    .nav-item i { margin-right: 0.75rem; font-size: 1.1rem; }

    /* --- Components --- */
    .stat-card {
      background: white; border-radius: 1rem; padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid #e5e7eb;
    }
    .stat-val { font-size: 2rem; font-weight: 700; color: var(--primary); line-height: 1.2; }
    .stat-label { font-size: 0.875rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }

    /* Tables */
    .table-card { background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
    .table th { background: #f9fafb; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; padding: 1rem; }
    .table td { vertical-align: middle; padding: 1rem; font-size: 0.9rem; }
    
    /* Status Badges */
    .badge-soft { padding: 0.35em 0.8em; border-radius: 2rem; font-weight: 600; font-size: 0.75rem; }
    .bg-green-soft { background: #dcfce7; color: #15803d; }
    .bg-red-soft { background: #fee2e2; color: #991b1b; }
    .bg-yellow-soft { background: #fef3c7; color: #92400e; }
    .bg-neutral-soft { background: #f3f4f6; color: #374151; }

    /* Buttons */
    .btn-primary { background-color: var(--primary); border-color: var(--primary); }
    .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
    .btn-outline-secondary.active { background-color: var(--primary); border-color: var(--primary); color: white; }

    /* View Sections */
    .view-section { display: none; animation: fadeIn 0.3s ease; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* HUV Checkbox */
    .huv-check { width: 1.2rem; height: 1.2rem; cursor: pointer; border-radius: 4px; accent-color: var(--primary); }
  </style>
</head>
<body>

  <div id="authOverlay">
    <div class="pin-box">
      <div class="mb-4">
        <img src="https://parrishhealthsystems.org/wp-content/uploads/2025/04/Logo_Thumbnail.png" alt="Parrish Health Systems" style="height: 80px; width: auto;">
      </div>
      <h3 class="fw-bold mb-1">Parrish Health Systems</h3>
      <p class="text-muted mb-4">Secure Dashboard Access</p>
      
      <input type="password" id="pinInput" class="form-control text-center fs-4 letter-spacing-2" placeholder="Enter PIN" maxlength="4" style="letter-spacing: 0.5em;">
      <div id="pinError" class="text-danger mt-3 small" style="display:none">Incorrect PIN</div>
    </div>
  </div>

  <div class="app-container" id="app">
    
    <aside class="sidebar">
      <div class="d-flex align-items-center mb-5 px-2">
        <img src="https://parrishhealthsystems.org/wp-content/uploads/2025/04/Logo_Thumbnail.png" alt="Logo" class="me-3" style="height: 40px; width: auto;">
        <div style="line-height: 1.2;">
          <h6 class="fw-bold m-0" style="white-space: nowrap;">Parrish Health Systems</h6>
          <span class="text-muted" style="font-size:0.75rem">Care Platform</span>
        </div>
      </div>

      <nav>
        <div class="nav-item active" onclick="switchView('dashboard')">
          <i class="bi bi-grid-1x2"></i> Overview
        </div>
        <div class="nav-item" onclick="switchView('cti')">
          <i class="bi bi-file-medical"></i> Certifications (CTI)
        </div>
        <div class="nav-item" onclick="switchView('huv')">
          <i class="bi bi-calendar-check"></i> HOPE Visits (HUV)
        </div>
      </nav>

      <div class="mt-auto">
        <div class="p-3 bg-light rounded-3">
          <small class="text-muted d-block mb-1">Current User</small>
          <div class="fw-bold">Administrator</div>
          <button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="location.reload()">Lock System</button>
        </div>
      </div>
    </aside>

    <main class="main-content">
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0" id="pageTitle">Overview</h4>
        <div class="text-end">
          <span class="badge bg-light text-dark border"><i class="bi bi-clock me-1"></i> <span id="currentDate"></span></span>
        </div>
      </div>

      <div id="view-dashboard" class="view-section active">
        <div class="row g-4 mb-4">
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-val" id="statTotal">-</div>
              <div class="stat-label">Total Patients</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-val text-warning" id="statRecerts">-</div>
              <div class="stat-label">Upcoming Recerts</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-val text-danger" id="statHuv">-</div>
              <div class="stat-label">Action Needed (HUV)</div>
            </div>
          </div>
        </div>

        <div class="card border-0 shadow-sm p-5 text-center bg-white rounded-4">
          <div class="mb-3">
             <img src="https://parrishhealthsystems.org/wp-content/uploads/2025/04/Logo_Thumbnail.png" style="height: 60px; opacity: 0.8;">
          </div>
          <h5>Welcome to Parrish Health Systems</h5>
          <p class="text-muted">Select "Certifications" or "HOPE Visits" from the sidebar to manage patient care.</p>
        </div>
      </div>

      <div id="view-cti" class="view-section">
        <div class="d-flex justify-content-between mb-3">
            <div class="btn-group">
                <button class="btn btn-outline-secondary active" id="btnCtiAll" onclick="filterCti('all')">All</button>
                <button class="btn btn-outline-secondary" id="btnCtiUpcoming" onclick="filterCti('upcoming')">Upcoming</button>
            </div>
            <button class="btn btn-primary btn-sm" onclick="openAddModal()">
                <i class="bi bi-plus-lg me-1"></i> Add Patient
            </button>
        </div>
        <div class="table-card">
          <table class="table mb-0">
            <thead>
              <tr>
                <th>Patient</th>
                <th>Admission Date</th>
                <th>Current Period</th>
                <th>Recertification Due</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="ctiTableBody">
                <tr><td colspan="5" class="text-center py-4">Loading CTI Data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="view-huv" class="view-section">
        <div class="alert alert-light border border-success text-success mb-3">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>HOPE Protocol:</strong> HUV1 (Days 6-15) â€¢ HUV2 (Days 16-30)
        </div>
        <div class="table-card">
          <table class="table mb-0">
            <thead>
              <tr>
                <th>Patient</th>
                <th>Start of Care</th>
                <th>HUV 1 Window</th>
                <th>Status</th>
                <th>HUV 2 Window</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="huvTableBody">
                <tr><td colspan="6" class="text-center py-4">Loading HUV Data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <div class="modal fade" id="patientModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title">Add Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="newPatientName" class="form-control mb-3" placeholder="Patient Name">
                <input type="date" id="newPatientDate" class="form-control mb-3">
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="savePatient()">Save Record</button>
            </div>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- STATE ---
    let ctiData = [];
    let huvData = [];
    const PIN = "2232";

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
        document.getElementById('pinInput').focus();
        
        // Pin Entry Listener
        document.getElementById('pinInput').addEventListener('keyup', (e) => {
            if(e.target.value === PIN) unlockApp();
            if(e.target.value.length === 4 && e.target.value !== PIN) {
                document.getElementById('pinError').style.display = 'block';
                e.target.value = '';
            }
        });
    });

    function unlockApp() {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        loadAllData();
    }

    // --- DATA LOADING ---
    function loadAllData() {
        if(typeof google === 'undefined') { console.warn('Not in GAS environment'); return; }

        // Fetch CTI Data
        google.script.run.withSuccessHandler(data => {
            ctiData = data;
            renderCtiTable(data);
            updateStats();
        }).getPatientData();

        // Fetch HUV Data
        google.script.run.withSuccessHandler(data => {
            huvData = data;
            renderHuvTable(data);
            updateStats();
        }).getHUVData();
    }

    // --- RENDERERS ---
    
    // 1. CTI Table
    function renderCtiTable(data) {
        const tbody = document.getElementById('ctiTableBody');
        if(!data.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center p-3">No patients found</td></tr>'; return; }
        
        tbody.innerHTML = data.map(p => {
            const status = getRecertStatus(p.recertStartDate);
            return `
            <tr>
                <td class="fw-bold">${p.name}</td>
                <td>${p.admissionDate}</td>
                <td><span class="badge bg-light text-dark border">${p.currentPeriod || 'N/A'}</span></td>
                <td>${p.recertPeriod || '-'}</td>
                <td>${status}</td>
            </tr>`;
        }).join('');
    }

    function getRecertStatus(dateStr) {
        if(!dateStr) return '';
        const due = new Date(dateStr);
        const today = new Date();
        const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
        
        if(diff < 0) return `<span class="badge-soft bg-red-soft">Overdue (${Math.abs(diff)}d)</span>`;
        if(diff <= 30) return `<span class="badge-soft bg-yellow-soft">Due in ${diff} days</span>`;
        return `<span class="badge-soft bg-green-soft">Active</span>`;
    }

    // 2. HUV Table
    function renderHuvTable(data) {
        const tbody = document.getElementById('huvTableBody');
        if(!data.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center p-3">No HUV data found</td></tr>'; return; }

        tbody.innerHTML = data.map((p, index) => {
            const h1 = calculateHuvStatus(p.socDate, 6, 15, p.huv1Done);
            const h2 = calculateHuvStatus(p.socDate, 16, 30, p.huv2Done);
            
            return `
            <tr>
                <td class="fw-bold">${p.name}</td>
                <td>${new Date(p.socDate).toLocaleDateString()}</td>
                <td>
                    <div class="small text-muted">${h1.range}</div>
                    ${h1.badge}
                </td>
                <td class="text-center">
                   <input type="checkbox" class="huv-check" 
                          ${p.huv1Done ? 'checked' : ''} 
                          onchange="toggleHuv(${p.row}, 1, this.checked)">
                </td>
                <td>
                    <div class="small text-muted">${h2.range}</div>
                    ${h2.badge}
                </td>
                <td class="text-center">
                   <input type="checkbox" class="huv-check" 
                          ${p.huv2Done ? 'checked' : ''} 
                          onchange="toggleHuv(${p.row}, 2, this.checked)">
                </td>
            </tr>`;
        }).join('');
    }

    function calculateHuvStatus(socDate, startDay, endDay, isDone) {
        if(isDone) return { range: 'Completed', badge: '<span class="badge-soft bg-green-soft">Done</span>' };
        
        const start = new Date(socDate); start.setDate(start.getDate() + startDay);
        const end = new Date(socDate); end.setDate(end.getDate() + endDay);
        const today = new Date();

        const rangeStr = `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}`;

        if(today > end) return { range: rangeStr, badge: '<span class="badge-soft bg-red-soft">Overdue</span>' };
        if(today >= start && today <= end) return { range: rangeStr, badge: '<span class="badge-soft bg-yellow-soft">Action Needed</span>' };
        return { range: rangeStr, badge: '<span class="badge-soft bg-neutral-soft">Upcoming</span>' };
    }

    // --- ACTIONS ---
    function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active'); // highlight nav

        const titles = { 'dashboard': 'Overview', 'cti': 'Certifications', 'huv': 'HOPE Visits' };
        document.getElementById('pageTitle').textContent = titles[viewName];
    }

    function filterCti(mode) {
        const btnAll = document.getElementById('btnCtiAll');
        const btnUp = document.getElementById('btnCtiUpcoming');
        
        if(mode === 'all') {
             btnAll.classList.add('active'); btnUp.classList.remove('active');
             renderCtiTable(ctiData);
        } else {
             btnAll.classList.remove('active'); btnUp.classList.add('active');
             const filtered = ctiData.filter(p => {
                 if(!p.recertStartDate) return false;
                 const diff = (new Date(p.recertStartDate) - new Date()) / 86400000;
                 return diff >= 0 && diff <= 30;
             });
             renderCtiTable(filtered);
        }
    }

    function toggleHuv(row, huvNum, isChecked) {
        google.script.run.updateHUVStatus(row, huvNum, isChecked);
    }
    
    function updateStats() {
        if(ctiData) document.getElementById('statTotal').textContent = ctiData.length;
        if(huvData) {
            // Count actionable HUVs
             let actionCount = 0;
             huvData.forEach(p => {
                 const h1 = calculateHuvStatus(p.socDate, 6, 15, p.huv1Done);
                 const h2 = calculateHuvStatus(p.socDate, 16, 30, p.huv2Done);
                 if(h1.badge.includes('Action') || h2.badge.includes('Action')) actionCount++;
             });
             document.getElementById('statHuv').textContent = actionCount;
        }
    }

    // CRUD Placeholders
    function openAddModal() { new bootstrap.Modal(document.getElementById('patientModal')).show(); }
    function savePatient() {
        const name = document.getElementById('newPatientName').value;
        const date = document.getElementById('newPatientDate').value;
        google.script.run.withSuccessHandler(() => {
            location.reload(); 
        }).addPatient(name, date);
    }
  </script>
</body>
</html>
