<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Dashboard</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    :root {
      --primary: #4f46e5; /* Modern Indigo */
      --primary-hover: #4338ca;
      --bg-surface: #f3f4f6;
      --card-bg: #ffffff;
      --text-dark: #111827;
      --text-muted: #6b7280;
      --border-color: #e5e7eb;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-surface);
      color: var(--text-dark);
      overflow-x: hidden;
    }

    /* --- Animations --- */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
    
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }

    /* --- Auth Screen --- */
    #authSection {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
    }

    .pin-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid white;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      border-radius: 1.5rem;
      padding: 3rem 2rem;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .pin-input {
      font-size: 2rem;
      letter-spacing: 0.5rem;
      text-align: center;
      border: 2px solid var(--border-color);
      border-radius: 1rem;
      padding: 1rem;
      transition: all 0.2s;
      background: #f9fafb;
    }
    
    .pin-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      outline: none;
    }

    /* --- Dashboard UI --- */
    .dashboard-container {
      display: none; /* Hidden by default */
      padding-bottom: 3rem;
    }

    .modern-card {
      background: var(--card-bg);
      border: none;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .scorecard {
      padding: 1.5rem;
      height: 100%;
      position: relative;
      overflow: hidden;
    }
    
    .scorecard:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .scorecard-value { font-size: 2.25rem; font-weight: 700; color: var(--primary); line-height: 1; margin-bottom: 0.5rem; }
    .scorecard-label { font-size: 0.875rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.025em; }
    
    /* Table Styling */
    .table-container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .table-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      background: white;
    }

    .table th {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background-color: #f9fafb;
      border-bottom: 1px solid var(--border-color);
      padding: 1rem;
    }
    
    .table td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
    .table tbody tr:last-child td { border-bottom: none; }
    .table tbody tr:hover { background-color: #f9fafb; }

    /* Badges & Buttons */
    .badge-soft { padding: 0.35em 0.8em; border-radius: 2rem; font-weight: 600; font-size: 0.75rem; }
    .badge-upcoming { background: #eff6ff; color: #1d4ed8; }
    .badge-pastdue { background: #fef2f2; color: #b91c1c; }
    .badge-neutral { background: #f3f4f6; color: #374151; }

    .btn-primary { background-color: var(--primary); border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; }
    .btn-primary:hover { background-color: var(--primary-hover); }
    
    .btn-toggle-group { background: #f3f4f6; padding: 0.25rem; border-radius: 0.75rem; display: inline-flex; }
    .btn-toggle { border: none; background: transparent; color: var(--text-muted); padding: 0.375rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
    .btn-toggle.active { background: white; color: var(--primary); shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .btn-toggle:hover:not(.active) { color: var(--text-dark); }

    .search-input { border: 1px solid var(--border-color); border-radius: 0.5rem; padding-left: 2.5rem; background-color: #fff; }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

    .loading-spinner { width: 3rem; height: 3rem; border: 4px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="authSection">
    <div class="pin-card fade-in">
      <div class="mb-4">
        <div class="bg-primary bg-opacity-10 text-primary d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width: 60px; height: 60px;">
          <i class="bi bi-shield-lock-fill fs-3"></i>
        </div>
        <h3 class="fw-bold mb-1">Welcome Back</h3>
        <p class="text-muted">Enter access PIN to continue</p>
      </div>
      <div class="mb-4">
        <input type="password" id="pinInput" class="form-control pin-input" maxlength="4" placeholder="••••" inputmode="numeric">
        <div id="pinError" class="text-danger mt-2 small" style="display:none; opacity:0; transition: opacity 0.3s;">
          <i class="bi bi-exclamation-circle me-1"></i> Incorrect PIN
        </div>
      </div>
      <button class="btn btn-primary w-100 py-2 rounded-3 fw-semibold" onclick="validatePin()">Access Dashboard</button>
    </div>
  </div>

  <div id="dashboardSection" class="container-fluid dashboard-container px-4">
    
    <div class="d-flex justify-content-between align-items-center py-4 mb-3">
      <div>
        <h4 class="fw-bold mb-0">Patient Dashboard</h4>
        <span class="text-muted small">Overview & Recertification Tracking</span>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="text-end d-none d-sm-block">
          <div class="fw-semibold" id="currentDate"></div>
          <div class="text-muted small" style="font-size: 0.75rem;">Admin View</div>
        </div>
        <button class="btn btn-light border rounded-circle" onclick="location.reload()" title="Logout">
          <i class="bi bi-box-arrow-right text-muted"></i>
        </button>
      </div>
    </div>

    <div class="row g-2 mb-4 align-items-center">
      <div class="col-auto">
        <select id="filterRange" class="form-select form-select-sm border-0 shadow-sm" style="min-width: 140px;">
          <option value="all">All Time</option>
          <option value="ytd">Year to Date</option>
          <option value="mtd">Month to Date</option>
          <option value="7">Last 7 Days</option>
          <option value="14">Last 14 Days</option>
          <option value="30">Last 30 Days</option>
        </select>
      </div>
      <div class="col-auto">
        <select id="filterYear" class="form-select form-select-sm border-0 shadow-sm" style="min-width: 100px;">
          <option value="all">All Years</option>
        </select>
      </div>
      <div class="col-auto ms-auto">
        <button class="btn btn-primary btn-sm px-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#patientModal" onclick="openAddModal()">
          <i class="bi bi-plus-lg me-1"></i>Add Patient
        </button>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-12 col-md-3">
        <div class="modern-card scorecard">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="scorecard-value" id="totalPatients">-</div>
              <div class="scorecard-label">Total Active Patients</div>
            </div>
            <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary">
              <i class="bi bi-people-fill fs-5"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="modern-card scorecard">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="scorecard-value" id="upcomingRecerts">-</div>
              <div class="scorecard-label">Upcoming Recerts</div>
            </div>
            <div class="bg-warning bg-opacity-10 p-2 rounded-3 text-warning">
              <i class="bi bi-clock-history fs-5"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div class="btn-toggle-group">
          <button type="button" class="btn-toggle active" id="btnUpcoming" onclick="setView('upcoming')">Upcoming</button>
          <button type="button" class="btn-toggle" id="btnPastDue" onclick="setView('pastdue')">Past Due</button>
        </div>
        
        <div class="position-relative">
          <i class="bi bi-search position-absolute text-muted" style="left:12px; top:50%; transform:translateY(-50%)"></i>
          <input type="text" id="searchInput" class="form-control form-control-sm search-input" placeholder="Search by name..." style="width: 240px" oninput="filterPatients()">
        </div>
      </div>

      <div class="card-body p-0">
        <div id="loadingState" class="d-flex justify-content-center align-items-center py-5">
          <div class="loading-spinner"></div>
        </div>
        
        <div id="tableContainer" class="table-responsive" style="display:none; max-height: 500px;">
          <table class="table mb-0">
            <thead class="sticky-top">
              <tr>
                <th>Patient Name</th>
                <th>Admission</th>
                <th>Current Period</th>
                <th>Recertification</th>
                <th>Status</th>
                <th style="width:80px">Edit</th>
              </tr>
            </thead>
            <tbody id="patientTableBody"></tbody>
          </table>
        </div>

        <div id="emptyState" class="text-center py-5 text-muted" style="display:none">
          <div class="bg-light d-inline-flex rounded-circle p-3 mb-3">
            <i class="bi bi-inbox fs-2 text-secondary"></i>
          </div>
          <p class="mb-0 fw-medium">No patients found</p>
          <small>Adjust filters or add a new patient</small>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="patientModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header border-bottom-0 pb-0">
          <h5 class="modal-title fw-bold" id="modalTitle">Add Patient</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body pt-4">
          <input type="hidden" id="editRow">
          <div class="mb-3">
            <label class="form-label small text-muted fw-bold text-uppercase">Patient Name</label>
            <input type="text" id="patientName" class="form-control bg-light border-0 py-2" placeholder="Ex: John Doe" required>
          </div>
          <div class="mb-3">
            <label class="form-label small text-muted fw-bold text-uppercase">Admission Date</label>
            <input type="date" id="admissionDate" class="form-control bg-light border-0 py-2" required>
          </div>
        </div>
        <div class="modal-footer border-top-0 pt-0 pb-4 px-3">
          <button type="button" class="btn btn-light text-danger btn-sm me-auto" id="deleteBtn" style="display:none" onclick="deletePatient()">
            <i class="bi bi-trash me-1"></i>Delete
          </button>
          <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary btn-sm px-4" onclick="savePatient()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allPatients = [];
    let filteredPatients = [];
    let currentView = 'upcoming';

    document.addEventListener('DOMContentLoaded', () => {
        // Set date in header
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', options);

        // Allow Enter key for PIN
        document.getElementById('pinInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') validatePin();
        });
        
        // Setup Filter Listeners
        document.getElementById('filterRange').addEventListener('change', filterPatients);
        document.getElementById('filterYear').addEventListener('change', filterPatients);
        
        // Focus PIN on load
        document.getElementById('pinInput').focus();
    });

    /* --- Security Logic --- */
    function validatePin() {
        const pin = document.getElementById('pinInput').value;
        const errorMsg = document.getElementById('pinError');
        const card = document.querySelector('.pin-card');

        if (pin === '2232') {
            // Success Animation
            document.getElementById('authSection').style.display = 'none';
            const dash = document.getElementById('dashboardSection');
            dash.style.display = 'block';
            dash.classList.add('fade-in');
            
            // Load Data only AFTER auth
            loadData();
        } else {
            // Error Animation
            errorMsg.style.display = 'block';
            errorMsg.style.opacity = '1';
            card.classList.remove('shake');
            void card.offsetWidth; // trigger reflow
            card.classList.add('shake');
            document.getElementById('pinInput').value = '';
        }
    }

    /* --- Data Logic (Unchanged but connected) --- */
    function loadData() {
      // Assuming Google Apps Script backend
      if(typeof google !== 'undefined' && google.script) {
          google.script.run.withSuccessHandler(data => {
            allPatients = data;
            loadYears();
            filterPatients();
          }).withFailureHandler(err => {
            console.error(err);
            showEmpty();
          }).getPatientData();
      } else {
          // Dev Mode / Fallback for testing without GAS
          console.log("Not in GAS environment.");
          showEmpty();
      }
    }

    function loadYears() {
      google.script.run.withSuccessHandler(years => {
        const sel = document.getElementById('filterYear');
        years.forEach(y => {
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y;
          sel.appendChild(opt);
        });
      }).getAvailableYears();
    }

    function filterPatients() {
      const range = document.getElementById('filterRange').value;
      const year = document.getElementById('filterYear').value;
      const search = document.getElementById('searchInput').value.toLowerCase();
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      filteredPatients = allPatients.filter(p => {
        if (!p.admissionDateRaw) return false;
        const admDate = new Date(p.admissionDateRaw);
        
        if (range !== 'all') {
          let startDate;
          if (range === 'ytd') startDate = new Date(now.getFullYear(), 0, 1);
          else if (range === 'mtd') startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          else startDate = new Date(today.getTime() - parseInt(range) * 86400000);
          if (admDate < startDate) return false;
        }

        if (year !== 'all' && admDate.getFullYear() !== parseInt(year)) return false;
        if (search && !p.name.toLowerCase().includes(search)) return false;
        return true;
      });

      filteredPatients.sort((a, b) => {
        if (!a.recertStartDate) return 1;
        if (!b.recertStartDate) return -1;
        return a.recertStartDate - b.recertStartDate;
      });

      const displayPatients = filteredPatients.filter(p => {
        if (!p.recertStartDate) return currentView === 'upcoming';
        const recertDate = new Date(p.recertStartDate);
        return currentView === 'upcoming' ? recertDate >= today : recertDate < today;
      });

      updateScoreCards();
      renderTable(displayPatients);
    }

    function updateScoreCards() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      document.getElementById('totalPatients').textContent = filteredPatients.length;
      
      const upcoming = filteredPatients.filter(p => {
        if (!p.recertStartDate) return false;
        const recertDate = new Date(p.recertStartDate);
        const daysUntil = (recertDate - today) / 86400000;
        return daysUntil >= 0 && daysUntil <= 30;
      }).length;
      
      document.getElementById('upcomingRecerts').textContent = upcoming;
    }

    function renderTable(patients) {
      document.getElementById('loadingState').style.display = 'none';
      const tbody = document.getElementById('patientTableBody');
      const container = document.getElementById('tableContainer');
      const empty = document.getElementById('emptyState');

      if (patients.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      container.style.display = 'block';
      empty.style.display = 'none';

      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      tbody.innerHTML = patients.map(p => {
        let status = '';
        if (p.recertStartDate) {
          const recertDate = new Date(p.recertStartDate);
          const daysUntil = Math.ceil((recertDate - today) / 86400000);
          if (daysUntil < 0) {
            status = `<span class="badge-soft badge-pastdue">${Math.abs(daysUntil)} days overdue</span>`;
          } else if (daysUntil <= 30) {
            status = `<span class="badge-soft badge-upcoming">${daysUntil} days left</span>`;
          } else {
            status = `<span class="badge-soft badge-neutral">${daysUntil} days</span>`;
          }
        }
        return `<tr>
          <td class="fw-semibold text-dark">${escapeHtml(p.name)}</td>
          <td class="text-muted">${p.admissionDate}</td>
          <td class="text-muted">${escapeHtml(p.currentPeriod)}</td>
          <td class="text-muted">${escapeHtml(p.recertPeriod)}</td>
          <td>${status}</td>
          <td>
            <button class="btn btn-sm btn-light text-primary border-0" onclick="openEditModal(${p.row},'${escapeJs(p.name)}','${p.admissionDateRaw}')">
              <i class="bi bi-pencil-square"></i>
            </button>
          </td>
        </tr>`;
      }).join('');
    }

    function setView(view) {
      currentView = view;
      document.getElementById('btnUpcoming').classList.toggle('active', view === 'upcoming');
      document.getElementById('btnPastDue').classList.toggle('active', view === 'pastdue');
      filterPatients();
    }

    /* --- Modal & CRUD Operations --- */
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'Add Patient';
      document.getElementById('editRow').value = '';
      document.getElementById('patientName').value = '';
      document.getElementById('admissionDate').value = '';
      document.getElementById('deleteBtn').style.display = 'none';
    }

    function openEditModal(row, name, dateRaw) {
      document.getElementById('modalTitle').textContent = 'Edit Patient';
      document.getElementById('editRow').value = row;
      document.getElementById('patientName').value = name;
      if (dateRaw) {
        const d = new Date(parseInt(dateRaw));
        document.getElementById('admissionDate').value = d.toISOString().split('T')[0];
      }
      document.getElementById('deleteBtn').style.display = 'block';
      new bootstrap.Modal(document.getElementById('patientModal')).show();
    }

    function savePatient() {
      const name = document.getElementById('patientName').value.trim();
      const date = document.getElementById('admissionDate').value;
      const row = document.getElementById('editRow').value;

      if (!name || !date) {
        alert('Please fill in all fields');
        return;
      }

      const callback = () => {
        bootstrap.Modal.getInstance(document.getElementById('patientModal')).hide();
        loadData();
      };

      if (row) {
        google.script.run.withSuccessHandler(callback).updatePatient(parseInt(row), name, date);
      } else {
        google.script.run.withSuccessHandler(callback).addPatient(name, date);
      }
    }

    function deletePatient() {
      if (!confirm('Are you sure you want to remove this patient?')) return;
      const row = document.getElementById('editRow').value;
      google.script.run.withSuccessHandler(() => {
        bootstrap.Modal.getInstance(document.getElementById('patientModal')).hide();
        loadData();
      }).deletePatient(parseInt(row));
    }

    function showEmpty() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('tableContainer').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function escapeJs(str) {
      if (!str) return '';
      return str.toString().replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"');
    }
  </script>
</body>
</html>